# Stage 09.5: Runtime Sanity Harness (Pre-Build Validation)

## AGENT-NATIVE EXECUTION
You are Claude executing Stage 09.5 for a SPECIFIC IDEA PACK. Validate app runtime requirements and simulate build success before Stage 10 generation.

## BUILD MODE VERIFICATION (CRITICAL)
Stage 09.5 can ONLY be executed via `build <IDEA_ID_OR_NAME>` command:
- Verify invocation came from build mode, not `run app factory`
- Require Stages 01, 02-09 artifacts exist (hard-fail if missing)
- Assert this stage is building ONE SPECIFIC IDEA only
- Hard-fail if executed during batch idea generation

## PURPOSE (MANDATORY GATE)
This stage prevents Stage 10 from generating apps that will fail at runtime or installation.

**VALIDATION TARGETS**:
- App boot sequence and initialization order
- Navigation flow completeness and accessibility
- Data flow validation from user actions to storage
- Error boundary coverage and recovery paths
- Subscription flow end-to-end simulation

## INPUTS
- Read: All previous stage JSONs (`runs/.../ideas/<idea_dir>/stages/stage02.json` through `stage09.json`)
- Read: `runs/.../ideas/<idea_dir>/uiux/uiux_prompt.md` (design contract)
- Read: `runs/.../ideas/<idea_dir>/technical/navigation_plan.json` (from stage02.7)
- Read: `runs/.../ideas/<idea_dir>/meta/idea.json` (canonical idea definition)

## OUTPUTS
- Write: `runs/.../ideas/<idea_dir>/stages/stage09.5.json` (runtime validation results)
- Write: `runs/.../ideas/<idea_dir>/outputs/stage09.5_execution.md` (execution log)
- Write: `runs/.../ideas/<idea_dir>/runtime/boot_sequence.json` (initialization plan)
- Write: `runs/.../ideas/<idea_dir>/runtime/flow_validation.json` (user flow coverage)
- Write: `runs/.../ideas/<idea_dir>/runtime/error_scenarios.json` (error handling plan)
- Write: `runs/.../ideas/<idea_dir>/runtime/sanity_checklist.md` (Stage 10 validation script)
- Update: `runs/.../ideas/<idea_dir>/meta/stage_status.json` (progress tracking)

## RUNTIME VALIDATION FRAMEWORK (MANDATORY)

### App Boot Sequence Validation
Simulate complete app initialization from cold start to user-ready state:

**BOOT SEQUENCE REQUIREMENTS**:
1. **Environment Loading**: Validate all required environment variables available
2. **SDK Initialization**: RevenueCat, analytics, crash reporting setup order
3. **Theme System**: Design token loading and fallback mechanisms
4. **Navigation Setup**: Expo Router initialization and screen registration
5. **Permission Requests**: Camera, microphone, health data access flows
6. **Data Persistence**: AsyncStorage, SQLite, or file system initialization
7. **Network Connectivity**: API connectivity and offline fallback states

**VALIDATION CHECKS**:
- Boot time MUST complete within 5 seconds on average device
- No critical dependencies missing during initialization
- Graceful degradation when permissions denied or network unavailable
- Error boundaries catch and recover from all initialization failures

### User Flow Completeness Analysis
Validate every user flow defined in previous stages can execute without placeholders:

**PRIMARY FLOW VALIDATION**:
- **Create Flow**: User can create core domain objects (tasks, sessions, recordings)
- **View Flow**: User can access and navigate through created objects
- **Edit Flow**: User can modify objects with proper validation and persistence
- **Delete Flow**: User can remove objects with confirmation and cleanup

**SECONDARY FLOW VALIDATION**:
- **Onboarding Flow**: Complete guest-to-trial-to-subscription journey
- **Settings Flow**: All preference changes persist and affect app behavior
- **Export Flow**: Data export functionality works with proper file handling
- **Backup/Restore Flow**: User data can be backed up and restored

**SUBSCRIPTION FLOW VALIDATION**:
- **Paywall Presentation**: RevenueCat offerings load and display correctly
- **Purchase Simulation**: Purchase flow handles success, failure, and edge cases
- **Entitlement Validation**: Feature gates respond correctly to subscription status
- **Restore Purchases**: Cross-device restoration works reliably

### Error Handling & Recovery Validation
Ensure app handles all error scenarios gracefully:

**NETWORK ERROR SCENARIOS**:
- No internet connection on app start
- Network timeout during critical operations
- API rate limiting or server errors
- RevenueCat service unavailable

**DEVICE ERROR SCENARIOS**:
- Low memory conditions and background app termination
- Permission changes after initial grant
- Device storage full during save operations
- Battery optimization killing background processes

**USER ERROR SCENARIOS**:
- Invalid input data and form validation
- Attempting premium features without subscription
- File import/export failures
- Settings that break app functionality

**RECOVERY REQUIREMENTS**:
- User-friendly error messages with actionable guidance
- Automatic retry mechanisms for transient failures
- Data integrity preserved during error conditions
- No data loss scenarios during normal app operation

### Data Flow & State Management Validation
Validate information architecture and state persistence:

**STATE PERSISTENCE VALIDATION**:
- User preferences persist across app restarts
- Core domain objects stored and retrieved correctly
- Partial form data recovers after app backgrounding
- Navigation state restoration after app termination

**DATA SYNCHRONIZATION VALIDATION**:
- Local data updates reflected immediately in UI
- Background data operations don't block user interface
- Data conflicts resolved predictably and transparently
- Export data matches displayed data exactly

## JSON SCHEMA

```json
{
  "meta": {
    "run_id": "string",
    "idea_id": "string", 
    "idea_name": "string",
    "idea_dir": "string",
    "source_root": "string",
    "input_stage_paths": ["array of files read"],
    "boundary_path": "string"
  },
  "runtime_validation": {
    "boot_sequence": {
      "initialization_steps": [
        {
          "step": "string",
          "dependencies": ["string"],
          "failure_modes": ["string"],
          "recovery_strategy": "string"
        }
      ],
      "estimated_boot_time": "number",
      "critical_path_validated": "boolean"
    },
    "user_flows": {
      "primary_flows": [
        {
          "flow_name": "string",
          "steps": ["string"],
          "data_requirements": ["string"],
          "completion_criteria": "string",
          "placeholder_free": "boolean"
        }
      ],
      "subscription_flows": {
        "paywall_presentation": "validated|failed",
        "purchase_simulation": "validated|failed",
        "entitlement_gates": "validated|failed",
        "restore_purchases": "validated|failed"
      }
    },
    "error_handling": {
      "network_scenarios": [
        {
          "scenario": "string",
          "detection_method": "string",
          "recovery_action": "string",
          "user_feedback": "string"
        }
      ],
      "device_scenarios": ["string"],
      "user_error_scenarios": ["string"],
      "error_boundary_coverage": "number"
    },
    "data_validation": {
      "persistence_layers": ["asyncstorage|sqlite|filesystem"],
      "state_recovery": "validated|failed",
      "data_integrity": "validated|failed",
      "synchronization": "validated|failed"
    }
  },
  "sanity_checklist": {
    "stage10_validation_steps": [
      {
        "check": "string",
        "validation_method": "automated|manual",
        "pass_criteria": "string",
        "failure_action": "string"
      }
    ],
    "critical_validations": ["string"],
    "performance_benchmarks": {
      "boot_time_target": "5_seconds",
      "navigation_response": "100ms",
      "data_load_timeout": "3_seconds"
    }
  },
  "gate_result": {
    "passed": "boolean",
    "confidence_score": "number",
    "blocking_issues": ["string"],
    "performance_warnings": ["string"],
    "recommendations": ["string"]
  }
}
```

## FAILURE CONDITIONS (HARD STOP)

Stage 09.5 MUST FAIL if:

### Boot Sequence Issues
- Critical initialization dependencies missing or undefined
- Estimated boot time exceeds 5 seconds on standard device
- Error boundaries don't cover initialization failure modes
- Required permissions not properly requested or handled

### User Flow Incompleteness
- Primary user flows contain placeholders or unimplemented steps
- Subscription flow simulation reveals blocking integration issues
- Data creation/modification flows lack proper validation or persistence
- Navigation flows create accessibility barriers or dead ends

### Error Handling Gaps
- Network error scenarios not handled gracefully
- Device limitation scenarios cause app crashes
- User error scenarios provide no recovery guidance
- Data loss possible during normal error conditions

### Data Flow Issues
- State persistence fails across app lifecycle events
- Data synchronization creates race conditions or corruption
- Export/import functionality produces inconsistent results
- Core domain objects cannot be reliably created or retrieved

## BOUNDARY ENFORCEMENT
This stage must ONLY read from:
- Current idea pack: `runs/.../ideas/<idea_dir>/`
- No cross-contamination with other ideas or runs

## EXECUTION STEPS

1. **Load Complete Specification**: Read all stages 02-09 JSON for complete app definition
2. **Simulate Boot Sequence**: Validate initialization order and dependencies
3. **Trace User Flows**: Follow every defined flow from start to completion
4. **Test Error Scenarios**: Validate graceful handling of all failure modes
5. **Validate Data Flows**: Confirm state management and persistence strategies
6. **Generate Validation Scripts**: Create Stage 10 validation checklist and tests
7. **Pass/Fail Decision**: Determine if app specification is runtime-viable
8. **Write Stage JSON**: Document validation results and sanity requirements

## SUCCESS CRITERIA
Stage 09.5 is complete when:
- [ ] `stage09.5.json` exists and validates against schema
- [ ] Boot sequence validated with <5 second initialization
- [ ] All user flows confirmed placeholder-free and complete
- [ ] Error handling coverage validated for all failure scenarios
- [ ] Data persistence and state management strategies confirmed viable
- [ ] Stage 10 validation checklist generated with specific pass/fail criteria
- [ ] Gate result indicates app specification ready for code generation

## HARD FAILURE CONDITIONS
- Boot sequence exceeds 5-second target or has missing dependencies → Write `stage09.5_failure.md` and stop
- User flows incomplete or contain unresolvable placeholders → Write `stage09.5_failure.md` and stop
- Error handling gaps create potential crash or data loss scenarios → Write `stage09.5_failure.md` and stop
- Data flow validation reveals state management or persistence issues → Write `stage09.5_failure.md` and stop
- Boundary violation (reading from wrong idea pack) → Write `stage09.5_failure.md` and stop

DO NOT output JSON in chat. Write all artifacts to disk and continue with Stage 10.