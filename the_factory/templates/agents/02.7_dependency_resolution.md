# Stage 02.7: Dependency Resolution Gate

## AGENT-NATIVE EXECUTION
You are Claude executing Stage 02.7 for a SPECIFIC IDEA PACK. Validate navigation strategy and package dependencies before UI/UX implementation.

## BUILD MODE VERIFICATION (CRITICAL)
Stage 02.7 can ONLY be executed via `build <IDEA_ID_OR_NAME>` command:
- Verify invocation came from build mode, not `run app factory`
- Require Stages 01, 02, 02.5 artifacts exist (hard-fail if missing)
- Assert this stage is building ONE SPECIFIC IDEA only
- Hard-fail if executed during batch idea generation

## PURPOSE (MANDATORY GATE)
This stage prevents technical implementation conflicts before UI/UX design begins.

**VALIDATION TARGETS**:
- Navigation architecture compatibility with Expo Router v4
- Package dependency resolution for app domain requirements
- React Native 0.76 + Expo SDK 52 compatibility
- RevenueCat integration strategy validation

## INPUTS
- Read: `runs/.../ideas/<idea_dir>/stages/stage02.json` (product specification)
- Read: `runs/.../ideas/<idea_dir>/stages/stage02.5.json` (product reality validation)
- Read: `runs/.../ideas/<idea_dir>/meta/idea.json` (canonical idea definition)
- Read: `runs/.../ideas/<idea_dir>/meta/boundary.json` (isolation enforcement)

## OUTPUTS
- Write: `runs/.../ideas/<idea_dir>/stages/stage02.7.json` (dependency resolution validation)
- Write: `runs/.../ideas/<idea_dir>/outputs/stage02.7_execution.md` (execution log)
- Write: `runs/.../ideas/<idea_dir>/technical/navigation_plan.json` (navigation architecture)
- Write: `runs/.../ideas/<idea_dir>/technical/dependency_plan.json` (package strategy)
- Write: `runs/.../ideas/<idea_dir>/technical/compatibility_matrix.md` (version validation)
- Update: `runs/.../ideas/<idea_dir>/meta/stage_status.json` (progress tracking)

## VENDOR DOCS FIRST (MANDATORY RESEARCH)

### Required Research Sources (IN ORDER)
**Primary Sources** (Use FIRST):
1. **Expo Documentation**: Read `the_factory/vendor/expo-docs/llms.txt`
2. **RevenueCat Documentation**: Read `the_factory/vendor/revenuecat-docs/llms.txt`

**Secondary Sources** (Use if primary insufficient):
3. **React Native Compatibility**: Web research for React Native 0.76 breaking changes
4. **Package Ecosystem**: npm/GitHub for domain-specific package availability

### Research Focus Areas
1. **Navigation Compatibility**: Expo Router v4 file-based navigation requirements
2. **RevenueCat Integration**: Latest SDK setup patterns and requirements
3. **Domain Packages**: Audio processing, data visualization, health integrations
4. **Expo SDK 52**: New capabilities and deprecated packages

## DEPENDENCY RESOLUTION VALIDATION (MANDATORY)

### Navigation Architecture Analysis
Determine optimal navigation structure for app requirements:

**VALIDATION RULES**:
- MUST use Expo Router v4 file-based navigation only
- FORBIDDEN: React Navigation components (@react-navigation/*)
- Navigation depth MUST NOT exceed 3 levels for accessibility
- Tab navigation MUST be limited to 5 primary sections maximum

**NAVIGATION PATTERNS BY DOMAIN**:
- **Investigation Apps**: Bottom tabs (Sessions, Analysis, Settings) + Stack navigation
- **Productivity Apps**: Bottom tabs (Tasks, Progress, Settings) + Modal screens
- **Health Apps**: Bottom tabs (Dashboard, Activities, Profile) + Detail screens
- **Creative Apps**: Stack navigation with custom headers + Modal galleries

### Package Dependency Strategy
Analyze domain-specific package requirements:

**AUDIO PROCESSING REQUIREMENTS**:
- React Native Audio packages (expo-av, react-native-sound)
- Recording permissions and file system access
- Background processing capabilities

**DATA VISUALIZATION REQUIREMENTS**:
- Chart libraries (react-native-chart-kit, victory-native)
- SVG rendering capabilities
- Performance considerations for large datasets

**HEALTH/FITNESS REQUIREMENTS**:
- Device sensor access (expo-sensors, react-native-health)
- Privacy compliance packages
- Data synchronization strategies

**COMPATIBILITY VALIDATION**:
- All packages MUST be compatible with Expo SDK 52
- All packages MUST support React Native 0.76
- NO packages requiring custom native modules without Expo support

### RevenueCat Integration Strategy
Define subscription implementation approach:

**INTEGRATION REQUIREMENTS**:
- RevenueCat React Native SDK latest version
- Environment-based API key configuration
- Paywall presentation strategy aligned with app navigation
- Restore purchases flow integration points

## JSON SCHEMA

```json
{
  "meta": {
    "run_id": "string",
    "idea_id": "string", 
    "idea_name": "string",
    "idea_dir": "string",
    "source_root": "string",
    "input_stage_paths": ["array of files read"],
    "boundary_path": "string"
  },
  "dependency_resolution": {
    "navigation_strategy": {
      "architecture": "expo-router-v4",
      "primary_structure": "tabs|stack|hybrid",
      "tab_sections": ["string"],
      "navigation_depth": "number",
      "modal_screens": ["string"],
      "accessibility_compliance": "boolean"
    },
    "package_strategy": {
      "core_dependencies": [
        {
          "package": "string",
          "version": "string",
          "purpose": "string",
          "expo_compatible": "boolean",
          "alternative_if_incompatible": "string"
        }
      ],
      "domain_packages": [
        {
          "package": "string",
          "domain": "audio|visualization|health|creative",
          "critical": "boolean",
          "fallback_strategy": "string"
        }
      ],
      "expo_sdk_compatibility": {
        "sdk_version": "52",
        "react_native_version": "0.76.x",
        "all_packages_compatible": "boolean",
        "incompatible_packages": ["string"],
        "resolution_strategy": "string"
      }
    },
    "revenuecat_integration": {
      "sdk_version": "string",
      "configuration_strategy": "environment-based",
      "paywall_placement": ["string"],
      "restore_flow_integration": "string",
      "testing_strategy": "sandbox"
    }
  },
  "technical_validation": {
    "navigation_conflicts": ["string"],
    "dependency_conflicts": ["string"],
    "performance_concerns": ["string"],
    "accessibility_issues": ["string"],
    "resolution_plan": ["string"]
  },
  "gate_result": {
    "passed": "boolean",
    "confidence_score": "number",
    "blocking_issues": ["string"],
    "recommendations": ["string"]
  }
}
```

## FAILURE CONDITIONS (HARD STOP)

Stage 02.7 MUST FAIL if:

### Navigation Architecture Issues
- Navigation structure conflicts with Expo Router v4 requirements
- Navigation depth exceeds accessibility guidelines (>3 levels)
- Tab structure incompatible with app domain requirements

### Dependency Resolution Failures
- Critical domain packages incompatible with Expo SDK 52
- Package conflicts that cannot be resolved
- Missing packages required for core app functionality

### RevenueCat Integration Conflicts
- RevenueCat SDK version incompatible with Expo SDK
- Subscription flow conflicts with navigation architecture
- Integration complexity exceeds single-build scope

### Performance & Accessibility Issues
- Package combination creates performance bottlenecks
- Navigation structure violates accessibility standards
- Dependency stack too complex for stable implementation

## EXECUTION STEPS

1. **Load Product Requirements**: Read Stage 02 and 02.5 JSON for technical needs
2. **Research Navigation Patterns**: Determine optimal Expo Router v4 architecture
3. **Analyze Domain Dependencies**: Identify required packages for app functionality
4. **Validate Compatibility**: Check all packages against Expo SDK 52 requirements
5. **Plan RevenueCat Integration**: Define subscription flow integration points
6. **Generate Technical Plans**: Write navigation, dependency, and compatibility artifacts
7. **Pass/Fail Decision**: Determine if technical stack is viable and performant
8. **Write Stage JSON**: Document validation results and gate decision

## BOUNDARY ENFORCEMENT
This stage must ONLY read from:
- Current idea pack: `runs/.../ideas/<idea_dir>/`
- Vendor documentation: `the_factory/vendor/*/llms.txt`
- No cross-contamination with other ideas or runs

## SUCCESS CRITERIA
Stage 02.7 is complete when:
- [ ] `stage02.7.json` exists and validates against schema
- [ ] Navigation architecture defined and Expo Router v4 compatible
- [ ] All domain packages identified and compatibility validated
- [ ] RevenueCat integration strategy defined and conflict-free
- [ ] Technical plans written to disk with specific implementation guidance
- [ ] Gate result indicates viable technical foundation for UI/UX design

## HARD FAILURE CONDITIONS
- Navigation architecture incompatible with Expo Router v4 → Write `stage02.7_failure.md` and stop
- Critical dependencies incompatible with Expo SDK 52 → Write `stage02.7_failure.md` and stop
- RevenueCat integration conflicts with app architecture → Write `stage02.7_failure.md` and stop
- Technical complexity exceeds single-build feasibility → Write `stage02.7_failure.md` and stop
- Boundary violation (reading from wrong idea pack) → Write `stage02.7_failure.md` and stop

DO NOT output JSON in chat. Write all artifacts to disk and continue with Stage 03.